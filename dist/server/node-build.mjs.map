{"version":3,"file":"node-build.mjs","sources":["../../server/routes/claude-results.ts","../../server/routes/gemini-results.ts","../../server/routes/openai-results.ts","../../server/routes/perplexity-results.ts","../../server/index.ts","../../server/node-build.ts"],"sourcesContent":["import type { RequestHandler } from \"express\";\r\nimport type { ClaudeResultsRequest, ClaudeResultsResponse } from \"@shared/api\";\r\n\r\nconst ANTHROPIC_API_URL = \"https://api.anthropic.com/v1/messages\";\r\n\r\nexport const handleClaudeResults: RequestHandler = async (req, res) => {\r\n  try {\r\n    console.log('üîç Claude handler - req.body:', req.body);\r\n    console.log('üîç Claude handler - req.method:', req.method);\r\n    console.log('üîç Claude handler - req.url:', req.url);\r\n    console.log('üîç Claude handler - req.headers:', req.headers);\r\n    \r\n    const { user_query, monitoring_keyword }: ClaudeResultsRequest = req.body ?? {};\r\n\r\n    if (!process.env.ANTHROPIC_API_KEY) {\r\n      res.status(500).json({ error: \"Missing ANTHROPIC_API_KEY\" });\r\n      return;\r\n    }\r\n\r\n    if (!user_query || typeof user_query !== \"string\") {\r\n      console.log('üîç Claude handler - user_query validation failed:', { user_query, type: typeof user_query });\r\n      res.status(400).json({ error: \"user_query is required\" });\r\n      return;\r\n    }\r\n\r\n    const prompt = `You are a strict formatter. Follow the output spec exactly.\r\n\r\nCONTEXT\r\n- Platform: Claude\r\n- user_query: \"${user_query}\"\r\n\r\nTASK\r\n1) Based on the query, return the 5 most relevant results.  \r\n   - Output strictly as a numbered list from 1 to 5.  \r\n   - Each item must be a COMPLETE result in the following exact 5-line format:\r\n     Title: <brand/model/main item>\r\n     Description: <up to 100 words>\r\n     Rating: <X/5>\r\n     Price: <$X or $A - $B>\r\n     Website: <domain or URL, if known>\r\n\r\n2) After the list, provide a simple summary of the results.\r\n\r\n3) After the summary, provide a ranking analysis for each item in this exact JSON format:\r\n{\r\n  \"ranking_analysis\": [\r\n    {\r\n      \"provider\": \"claude\",\r\n      \"target\": \"<item title>\",\r\n      \"rank\": <position number>,\r\n      \"matched_keywords\": [\"<keywords from query that matched>\"],\r\n      \"contextual_signals\": [\"<contextual mentions like comparisons, expert mentions>\"],\r\n      \"competitor_presence\": [\"<competitors and their ranks>\"],\r\n      \"sentiment\": \"<positive|neutral|negative>\",\r\n      \"citation_domains\": [\"<domains mentioned>\"],\r\n      \"llm_reasoning\": \"<brief explanation of why ranked this position>\"\r\n    }\r\n  ]\r\n}\r\n\r\n4) MANDATORY: If \"${monitoring_keyword || \"the query topic\"}\" appears anywhere in the results (position 2-5), you MUST provide improvement recommendations in this exact JSON format:\r\n{\r\n  \"improvement_recommendations\": [\r\n    {\r\n      \"category\": \"SEO & Content Strategy\",\r\n      \"title\": \"Optimize ${monitoring_keyword || \"the target\"} content strategy\",\r\n      \"description\": \"Create targeted content highlighting ${monitoring_keyword || \"the target\"}'s unique features and benefits\",\r\n      \"timeframe\": \"immediate\",\r\n      \"expectedImpact\": \"Could improve ranking by 1-2 positions\"\r\n    },\r\n    {\r\n      \"category\": \"Brand Strategy\", \r\n      \"title\": \"Enhance ${monitoring_keyword || \"the target\"} brand visibility\",\r\n      \"description\": \"Increase ${monitoring_keyword || \"the target\"} mentions and reviews across key platforms\",\r\n      \"timeframe\": \"mid-term\",\r\n      \"expectedImpact\": \"Better brand recognition and higher rankings\"\r\n    }\r\n  ]\r\n}\r\n\r\nCRITICAL: Always include improvement recommendations if ${monitoring_keyword || \"the target\"} is found at positions 2-5.\r\n\r\nRULES\r\n- No preface, no explanations, no extra lines.  \r\n- Keep descriptions short and factual.  \r\n- Follow format strictly.\r\n- Include ranking analysis for ALL 5 items.`;\r\n\r\n    const response = await fetch(ANTHROPIC_API_URL, {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"x-api-key\": process.env.ANTHROPIC_API_KEY,\r\n        \"anthropic-version\": \"2023-06-01\",\r\n        \"content-type\": \"application/json\",\r\n      },\r\n      body: JSON.stringify({\r\n        model: \"claude-3-5-sonnet-20241022\",\r\n        max_tokens: 2048,\r\n        messages: [{ role: \"user\", content: prompt }],\r\n      }),\r\n    });\r\n\r\n    if (!response.ok) {\r\n      const errText = await response.text();\r\n      res.status(response.status).json({ error: errText });\r\n      return;\r\n    }\r\n\r\n    const data = (await response.json()) as { content?: Array<{ text?: string }> };\r\n    const text = data?.content?.[0]?.text ?? \"\";\r\n    \r\n    console.log('üîç Claude full response text:', text);\r\n    console.log('üîç Claude response contains improvement_recommendations:', text.includes('improvement_recommendations'));\r\n\r\n    // Check if monitoring keyword appears in the results\r\n    let keywordPosition = -1;\r\n    if (monitoring_keyword) {\r\n      const lines = text.split('\\n');\r\n      for (let i = 0; i < lines.length; i++) {\r\n        const line = lines[i];\r\n        if (line.includes('Title:') && line.toLowerCase().includes(monitoring_keyword.toLowerCase())) {\r\n          // Extract position number from the preceding numbered list item\r\n          for (let j = i - 1; j >= 0; j--) {\r\n            const match = lines[j].match(/^(\\d+)\\)/);\r\n            if (match) {\r\n              keywordPosition = parseInt(match[1]);\r\n              break;\r\n            }\r\n          }\r\n          break;\r\n        }\r\n      }\r\n    }\r\n\r\n    // Try to extract ranking analysis and improvement recommendations from the response\r\n    let rankingAnalysis = [];\r\n    let improvementRecommendations = [];\r\n    try {\r\n      // Find the start of the JSON block\r\n      const jsonStart = text.indexOf('{\\n  \"ranking_analysis\":');\r\n      if (jsonStart !== -1) {\r\n        // Extract from the start to the end of the text (assuming JSON is at the end)\r\n        const jsonText = text.substring(jsonStart);\r\n        \r\n        // Try to find the end of the JSON object by counting braces\r\n        let braceCount = 0;\r\n        let jsonEnd = -1;\r\n        \r\n        for (let i = 0; i < jsonText.length; i++) {\r\n          if (jsonText[i] === '{') braceCount++;\r\n          if (jsonText[i] === '}') braceCount--;\r\n          if (braceCount === 0) {\r\n            jsonEnd = i + 1;\r\n            break;\r\n          }\r\n        }\r\n        \r\n        if (jsonEnd !== -1) {\r\n          const jsonString = jsonText.substring(0, jsonEnd);\r\n          console.log('üîç Claude extracted JSON string:', jsonString);\r\n          const analysisData = JSON.parse(jsonString);\r\n          rankingAnalysis = analysisData.ranking_analysis || [];\r\n          console.log('üîç Claude parsed ranking analysis:', rankingAnalysis);\r\n          \r\n          // Also try to extract improvement recommendations\r\n          const improvementStart = text.indexOf('{\\n  \"improvement_recommendations\":');\r\n          if (improvementStart !== -1) {\r\n            const improvementText = text.substring(improvementStart);\r\n            let improvementBraceCount = 0;\r\n            let improvementEnd = -1;\r\n            \r\n            for (let i = 0; i < improvementText.length; i++) {\r\n              if (improvementText[i] === '{') improvementBraceCount++;\r\n              if (improvementText[i] === '}') improvementBraceCount--;\r\n              if (improvementBraceCount === 0) {\r\n                improvementEnd = i + 1;\r\n                break;\r\n              }\r\n            }\r\n            \r\n            if (improvementEnd !== -1) {\r\n              try {\r\n                const improvementJsonString = improvementText.substring(0, improvementEnd);\r\n                console.log('üîç Claude extracted improvement JSON:', improvementJsonString);\r\n                const improvementData = JSON.parse(improvementJsonString);\r\n                improvementRecommendations = improvementData.improvement_recommendations || [];\r\n                console.log('üîç Claude parsed improvement recommendations:', improvementRecommendations);\r\n              } catch (e) {\r\n                console.log('üîç Claude failed to parse improvement recommendations:', e);\r\n              }\r\n            }\r\n          }\r\n        } else {\r\n          // Try to extract partial JSON if it's truncated\r\n          console.log('üîç Claude JSON appears truncated, trying to extract partial data');\r\n          try {\r\n            // Look for individual ranking analysis objects\r\n            const analysisMatches = jsonText.matchAll(/\\{\\s*\"provider\"[^}]*\"llm_reasoning\"[^}]*\\}/g);\r\n            for (const match of analysisMatches) {\r\n              try {\r\n                const partialAnalysis = JSON.parse(match[0]);\r\n                if (partialAnalysis.provider && partialAnalysis.llm_reasoning) {\r\n                  rankingAnalysis.push(partialAnalysis);\r\n                }\r\n              } catch (e) {\r\n                console.log('üîç Claude failed to parse partial analysis:', match[0]);\r\n              }\r\n            }\r\n            console.log('üîç Claude extracted partial ranking analysis:', rankingAnalysis);\r\n          } catch (error) {\r\n            console.log('üîç Claude failed to extract partial JSON:', error);\r\n          }\r\n        }\r\n      } else {\r\n        console.log('üîç Claude: No ranking_analysis JSON found in response');\r\n        console.log('üîç Claude response text preview:', text.substring(0, 500));\r\n      }\r\n    } catch (error) {\r\n      console.error('Claude failed to parse ranking analysis:', error);\r\n      console.error('Claude error details:', error);\r\n    }\r\n\r\n    const payload: ClaudeResultsResponse = { \r\n      text,\r\n      rankingAnalysis,\r\n      keywordPosition: keywordPosition > 0 ? keywordPosition : undefined,\r\n      monitoringKeyword: monitoring_keyword,\r\n      improvementRecommendations: improvementRecommendations.length > 0 ? improvementRecommendations : undefined\r\n    };\r\n    res.json(payload);\r\n  } catch (error) {\r\n    res.status(500).json({ error: (error as Error).message });\r\n  }\r\n};\r\n\r\n\r\n","import type { RequestHandler } from \"express\";\r\nimport type { GeminiResultsRequest, GeminiResultsResponse, RankingAnalysisResponse } from \"@shared/api\";\r\n\r\nconst GEMINI_URL =\r\n  \"https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent\";\r\n\r\nexport const handleGeminiResults: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { user_query, monitoring_keyword }: GeminiResultsRequest = req.body ?? {};\r\n\r\n    if (!process.env.GEMINI_API_KEY) {\r\n      res.status(500).json({ error: \"Missing GEMINI_API_KEY\" });\r\n      return;\r\n    }\r\n\r\n    if (!user_query || typeof user_query !== \"string\") {\r\n      res.status(400).json({ error: \"user_query is required\" });\r\n      return;\r\n    }\r\n\r\n    const prompt = `You are a strict formatter. Follow the output spec exactly.\r\n\r\nCONTEXT\r\n- Platform: Gemini\r\n- user_query: \"${user_query}\"\r\n\r\nTASK\r\n1) Based on the query, return the 5 most relevant results.  \r\n   - Output strictly as a numbered list from 1 to 5.  \r\n   - Each item must be a COMPLETE result in the following exact 5-line format:\r\n     Title: <brand/model/main item>\r\n     Description: <up to 100 words>\r\n     Rating: <X/5>\r\n     Price: <$X or $A - $B>\r\n     Website: <domain or URL, if known>\r\n\r\n2) After the list, provide a simple summary of the results.\r\n\r\n3) After the summary, provide a ranking analysis for each item in this exact JSON format:\r\n{\r\n  \"ranking_analysis\": [\r\n    {\r\n      \"provider\": \"gemini\",\r\n      \"target\": \"<item title>\",\r\n      \"rank\": <position number>,\r\n      \"matched_keywords\": [\"<keywords from query that matched>\"],\r\n      \"contextual_signals\": [\"<contextual mentions like comparisons, expert mentions>\"],\r\n      \"competitor_presence\": [\"<competitors and their ranks>\"],\r\n      \"sentiment\": \"<positive|neutral|negative>\",\r\n      \"citation_domains\": [\"<domains mentioned>\"],\r\n      \"llm_reasoning\": \"<brief explanation of why ranked this position>\"\r\n    }\r\n  ]\r\n}\r\n\r\n4) MANDATORY: If \"${monitoring_keyword || \"the query topic\"}\" appears anywhere in the results (position 2-5), you MUST provide improvement recommendations in this exact JSON format:\r\n{\r\n  \"improvement_recommendations\": [\r\n    {\r\n      \"category\": \"SEO & Content Strategy\",\r\n      \"title\": \"Optimize ${monitoring_keyword || \"the target\"} content strategy\",\r\n      \"description\": \"Create targeted content highlighting ${monitoring_keyword || \"the target\"}'s unique features and benefits\",\r\n      \"timeframe\": \"immediate\",\r\n      \"expectedImpact\": \"Could improve ranking by 1-2 positions\"\r\n    },\r\n    {\r\n      \"category\": \"Brand Strategy\", \r\n      \"title\": \"Enhance ${monitoring_keyword || \"the target\"} brand visibility\",\r\n      \"description\": \"Increase ${monitoring_keyword || \"the target\"} mentions and reviews across key platforms\",\r\n      \"timeframe\": \"mid-term\",\r\n      \"expectedImpact\": \"Better brand recognition and higher rankings\"\r\n    }\r\n  ]\r\n}\r\n\r\nCRITICAL: Always include improvement recommendations if ${monitoring_keyword || \"the target\"} is found at positions 2-5.\r\n\r\nRULES\r\n- No preface, no explanations, no extra lines.  \r\n- Keep descriptions short and factual.  \r\n- Follow format strictly.\r\n- Include ranking analysis for ALL 5 items.`;\r\n\r\n    async function callGemini(url: string) {\r\n      console.log('üîç Gemini calling URL (UPDATED CODE):', url);\r\n      return fetch(url, {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n          \"x-goog-api-key\": process.env.GEMINI_API_KEY,\r\n        },\r\n        body: JSON.stringify({\r\n          contents: [{ parts: [{ text: prompt }] }],\r\n          generationConfig: {\r\n            temperature: 0.4,\r\n            maxOutputTokens: 3072,\r\n          },\r\n        }),\r\n      });\r\n    }\r\n\r\n    // Retry with exponential backoff on 429/5xx\r\n    const modelUrls = [\r\n      \"https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent\",\r\n      \"https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-latest:generateContent\",\r\n    ];\r\n\r\n    let resp = await callGemini(modelUrls[0]);\r\n\r\n    if (!resp.ok) {\r\n      const firstError = { status: resp.status, body: await resp.text() };\r\n      console.log('üîç Gemini first request failed:', firstError);\r\n      \r\n      // Special handling for 429 (rate limit) errors\r\n      if (resp.status === 429) {\r\n        console.log('‚ö†Ô∏è Rate limit hit, waiting before retry...');\r\n        // Wait longer for rate limit errors\r\n        await new Promise((r) => setTimeout(r, 1000)); // Reduced to 1 second initial delay\r\n      }\r\n      \r\n      // Try fallback model with retries\r\n      let attempt = 0;\r\n      const maxAttempts = 3;\r\n      while (attempt < maxAttempts) {\r\n        const delayMs = resp.status === 429 ? 1000 * Math.pow(2, attempt) : 300 * Math.pow(2, attempt);\r\n        await new Promise((r) => setTimeout(r, delayMs));\r\n        resp = await callGemini(modelUrls[Math.min(1, attempt)]);\r\n        if (resp.ok) break;\r\n        attempt++;\r\n      }\r\n      if (!resp.ok) {\r\n        const text = await resp.text();\r\n        console.error('‚ùå Gemini request failed after retries:', { status: resp.status, text });\r\n        res.status(resp.status).json({ \r\n          error: \"Gemini request failed\", \r\n          details: resp.status === 429 ? \"Rate limit exceeded. Please try again in a few minutes.\" : \"API request failed\",\r\n          firstError, \r\n          finalError: text \r\n        });\r\n        return;\r\n      }\r\n    }\r\n\r\n    const json = (await resp.json()) as any;\r\n\r\n    // Try multiple shapes for compatibility\r\n    let text: string = \"\";\r\n    const cand0 = json?.candidates?.[0];\r\n    if (cand0?.content?.parts?.[0]?.text) text = cand0.content.parts[0].text as string;\r\n    else if (Array.isArray(cand0?.content) && cand0.content[0]?.parts?.[0]?.text) text = cand0.content[0].parts[0].text as string;\r\n    else if (cand0?.content?.parts && typeof cand0.content.parts === 'string') text = cand0.content.parts as string;\r\n\r\n    if (!text || typeof text !== 'string') {\r\n      res.status(502).json({ error: \"Gemini returned no text\", details: { finishReason: cand0?.finishReason, safetyRatings: cand0?.safetyRatings } });\r\n      return;\r\n    }\r\n\r\n    // Check if monitoring keyword appears in the results\r\n    let keywordPosition = -1;\r\n    if (monitoring_keyword) {\r\n      const lines = text.split('\\n');\r\n      for (let i = 0; i < lines.length; i++) {\r\n        const line = lines[i];\r\n        if (line.includes('Title:') && line.toLowerCase().includes(monitoring_keyword.toLowerCase())) {\r\n          // Extract position number from the preceding numbered list item\r\n          for (let j = i - 1; j >= 0; j--) {\r\n            const match = lines[j].match(/^(\\d+)\\)/);\r\n            if (match) {\r\n              keywordPosition = parseInt(match[1]);\r\n              break;\r\n            }\r\n          }\r\n          break;\r\n        }\r\n      }\r\n    }\r\n\r\n    // Try to extract ranking analysis and improvement recommendations from the response\r\n    let rankingAnalysis: RankingAnalysisResponse[] = [];\r\n    let improvementRecommendations = [];\r\n    try {\r\n      // Look for JSON block with ranking_analysis - be more flexible with formatting\r\n      const jsonPattern = /\\{\\s*\"ranking_analysis\"\\s*:/;\r\n      const jsonMatch = text.match(jsonPattern);\r\n      \r\n      if (jsonMatch) {\r\n        const jsonStart = jsonMatch.index!;\r\n        const jsonText = text.substring(jsonStart);\r\n        \r\n        // Try to find the end of the JSON object by counting braces\r\n        let braceCount = 0;\r\n        let jsonEnd = -1;\r\n        \r\n        for (let i = 0; i < jsonText.length; i++) {\r\n          if (jsonText[i] === '{') braceCount++;\r\n          if (jsonText[i] === '}') braceCount--;\r\n          if (braceCount === 0) {\r\n            jsonEnd = i + 1;\r\n            break;\r\n          }\r\n        }\r\n        \r\n        if (jsonEnd !== -1) {\r\n          const jsonString = jsonText.substring(0, jsonEnd);\r\n          console.log('üîç Gemini extracted JSON string:', jsonString);\r\n          const analysisData = JSON.parse(jsonString);\r\n          rankingAnalysis = analysisData.ranking_analysis || [];\r\n          console.log('üîç Gemini parsed ranking analysis:', rankingAnalysis);\r\n          \r\n          // Also try to extract improvement recommendations\r\n          const improvementStart = text.indexOf('{\\n  \"improvement_recommendations\":');\r\n          if (improvementStart !== -1) {\r\n            const improvementText = text.substring(improvementStart);\r\n            let improvementBraceCount = 0;\r\n            let improvementEnd = -1;\r\n            \r\n            for (let i = 0; i < improvementText.length; i++) {\r\n              if (improvementText[i] === '{') improvementBraceCount++;\r\n              if (improvementText[i] === '}') improvementBraceCount--;\r\n              if (improvementBraceCount === 0) {\r\n                improvementEnd = i + 1;\r\n                break;\r\n              }\r\n            }\r\n            \r\n            if (improvementEnd !== -1) {\r\n              try {\r\n                const improvementJsonString = improvementText.substring(0, improvementEnd);\r\n                console.log('üîç Gemini extracted improvement JSON:', improvementJsonString);\r\n                const improvementData = JSON.parse(improvementJsonString);\r\n                improvementRecommendations = improvementData.improvement_recommendations || [];\r\n                console.log('üîç Gemini parsed improvement recommendations:', improvementRecommendations);\r\n              } catch (e) {\r\n                console.log('üîç Gemini failed to parse improvement recommendations:', e);\r\n              }\r\n            }\r\n          }\r\n        } else {\r\n          // Try to extract partial JSON if it's truncated\r\n          console.log('üîç Gemini JSON appears truncated, trying to extract partial data');\r\n          try {\r\n            // Look for individual ranking analysis objects\r\n            const analysisMatches = jsonText.matchAll(/\\{\\s*\"provider\"[^}]*\"llm_reasoning\"[^}]*\\}/g);\r\n            for (const match of analysisMatches) {\r\n              try {\r\n                const partialAnalysis = JSON.parse(match[0]);\r\n                if (partialAnalysis.provider && partialAnalysis.llm_reasoning) {\r\n                  rankingAnalysis.push(partialAnalysis);\r\n                }\r\n              } catch (e) {\r\n                console.log('üîç Gemini failed to parse partial analysis:', match[0]);\r\n              }\r\n            }\r\n            console.log('üîç Gemini extracted partial ranking analysis:', rankingAnalysis);\r\n          } catch (error) {\r\n            console.log('üîç Gemini failed to extract partial JSON:', error);\r\n          }\r\n        }\r\n      } else {\r\n        console.log('üîç Gemini: No ranking_analysis JSON found in response');\r\n        console.log('üîç Gemini response text preview:', text.substring(0, 500));\r\n      }\r\n    } catch (error) {\r\n      console.error('Gemini failed to parse ranking analysis:', error);\r\n      console.error('Gemini error details:', error);\r\n    }\r\n\r\n    const payload: GeminiResultsResponse = { \r\n      text,\r\n      rankingAnalysis,\r\n      keywordPosition: keywordPosition > 0 ? keywordPosition : undefined,\r\n      monitoringKeyword: monitoring_keyword,\r\n      improvementRecommendations: improvementRecommendations.length > 0 ? improvementRecommendations : undefined\r\n    };\r\n    res.json(payload);\r\n  } catch (error) {\r\n    res.status(500).json({ error: (error as Error).message });\r\n  }\r\n};\r\n\r\n\r\n","import type { RequestHandler } from \"express\";\r\nimport type { OpenAIResultsRequest, OpenAIResultsResponse, RankingAnalysisResponse } from \"@shared/api\";\r\n\r\nconst OPENAI_URL = \"https://api.openai.com/v1/chat/completions\";\r\n\r\nexport const handleOpenAIResults: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { user_query, monitoring_keyword }: OpenAIResultsRequest = req.body ?? {};\r\n\r\n    if (!process.env.OPENAI_API_KEY) {\r\n      res.status(500).json({ error: \"Missing OPENAI_API_KEY\" });\r\n      return;\r\n    }\r\n\r\n    if (!user_query || typeof user_query !== \"string\") {\r\n      res.status(400).json({ error: \"user_query is required\" });\r\n      return;\r\n    }\r\n\r\n    const prompt = `You are a strict formatter. Follow the output spec exactly.\r\n\r\nCONTEXT\r\n- Platform: OpenAI\r\n- user_query: \"${user_query}\"\r\n\r\nTASK\r\n1) Based on the query, return the 5 most relevant results.  \r\n   - Output strictly as a numbered list from 1 to 5.  \r\n   - Each item must be a COMPLETE result in the following exact 5-line format:\r\n     Title: <brand/model/main item>\r\n     Description: <up to 100 words>\r\n     Rating: <X/5>\r\n     Price: <$X or $A - $B>\r\n     Website: <domain or URL, if known>\r\n\r\n2) After the list, provide a simple summary of the results.\r\n\r\n3) After the summary, provide a ranking analysis for each item in this exact JSON format:\r\n{\r\n  \"ranking_analysis\": [\r\n    {\r\n      \"provider\": \"openai\",\r\n      \"target\": \"<item title>\",\r\n      \"rank\": <position number>,\r\n      \"matched_keywords\": [\"<keywords from query that matched>\"],\r\n      \"contextual_signals\": [\"<contextual mentions like comparisons, expert mentions>\"],\r\n      \"competitor_presence\": [\"<competitors and their ranks>\"],\r\n      \"sentiment\": \"<positive|neutral|negative>\",\r\n      \"citation_domains\": [\"<domains mentioned>\"],\r\n      \"llm_reasoning\": \"<brief explanation of why ranked this position>\"\r\n    }\r\n  ]\r\n}\r\n\r\n4) MANDATORY: If \"${monitoring_keyword || \"the query topic\"}\" appears anywhere in the results (position 2-5), you MUST provide improvement recommendations in this exact JSON format:\r\n{\r\n  \"improvement_recommendations\": [\r\n    {\r\n      \"category\": \"SEO & Content Strategy\",\r\n      \"title\": \"Optimize ${monitoring_keyword || \"the target\"} content strategy\",\r\n      \"description\": \"Create targeted content highlighting ${monitoring_keyword || \"the target\"}'s unique features and benefits\",\r\n      \"timeframe\": \"immediate\",\r\n      \"expectedImpact\": \"Could improve ranking by 1-2 positions\"\r\n    },\r\n    {\r\n      \"category\": \"Brand Strategy\", \r\n      \"title\": \"Enhance ${monitoring_keyword || \"the target\"} brand visibility\",\r\n      \"description\": \"Increase ${monitoring_keyword || \"the target\"} mentions and reviews across key platforms\",\r\n      \"timeframe\": \"mid-term\",\r\n      \"expectedImpact\": \"Better brand recognition and higher rankings\"\r\n    }\r\n  ]\r\n}\r\n\r\nCRITICAL: Always include improvement recommendations if ${monitoring_keyword || \"the target\"} is found at positions 2-5.\r\n\r\nRULES\r\n- No preface, no explanations, no extra lines.  \r\n- Keep descriptions short and factual.  \r\n- Follow format strictly.\r\n- Include ranking analysis for ALL 5 items.`;\r\n\r\n    // Retry wrapper for OpenAI with timeout\r\n    async function callOpenAI() {\r\n      const controller = new AbortController();\r\n      const timeoutId = setTimeout(() => controller.abort(), 20000); // 20 second timeout\r\n      \r\n      try {\r\n        const response = await fetch(OPENAI_URL, {\r\n          method: \"POST\",\r\n          signal: controller.signal,\r\n          headers: {\r\n            \"Content-Type\": \"application/json\",\r\n            Authorization: `Bearer ${process.env.OPENAI_API_KEY}`,\r\n          },\r\n          body: JSON.stringify({\r\n            model: \"gpt-3.5-turbo\",\r\n            messages: [{ role: \"user\", content: prompt }],\r\n            max_tokens: 1500,\r\n            temperature: 0.1,\r\n          }),\r\n        });\r\n        clearTimeout(timeoutId);\r\n        return response;\r\n      } catch (error: any) {\r\n        clearTimeout(timeoutId);\r\n        if (error.name === 'AbortError') {\r\n          throw new Error('OpenAI request timed out after 30 seconds');\r\n        }\r\n        throw error;\r\n      }\r\n    }\r\n\r\n    const resp = await callOpenAI();\r\n\r\n    if (!resp.ok) {\r\n      const text = await resp.text();\r\n      res.status(resp.status).json({ error: \"OpenAI request failed\", details: text });\r\n      return;\r\n    }\r\n\r\n    const json = (await resp.json()) as {\r\n      choices?: Array<{ message?: { content?: string } }>;\r\n    };\r\n    const text = json?.choices?.[0]?.message?.content ?? \"\";\r\n    \r\n    console.log('üîç OpenAI full response text:', text);\r\n    console.log('üîç OpenAI response contains improvement_recommendations:', text.includes('improvement_recommendations'));\r\n\r\n    // Check if monitoring keyword appears in the results\r\n    let keywordPosition = -1;\r\n    if (monitoring_keyword) {\r\n      const lines = text.split('\\n');\r\n      for (let i = 0; i < lines.length; i++) {\r\n        const line = lines[i];\r\n        if (line.includes('Title:') && line.toLowerCase().includes(monitoring_keyword.toLowerCase())) {\r\n          // Extract position number from the preceding numbered list item\r\n          for (let j = i - 1; j >= 0; j--) {\r\n            const match = lines[j].match(/^(\\d+)\\)/);\r\n            if (match) {\r\n              keywordPosition = parseInt(match[1]);\r\n              break;\r\n            }\r\n          }\r\n          break;\r\n        }\r\n      }\r\n    }\r\n\r\n    // Try to extract ranking analysis and improvement recommendations from the response\r\n    let rankingAnalysis: RankingAnalysisResponse[] = [];\r\n    let improvementRecommendations = [];\r\n    try {\r\n      // Look for JSON block with ranking_analysis - be more flexible with formatting\r\n      const jsonPattern = /\\{\\s*\"ranking_analysis\"\\s*:/;\r\n      const jsonMatch = text.match(jsonPattern);\r\n      \r\n      if (jsonMatch) {\r\n        const jsonStart = jsonMatch.index!;\r\n        const jsonText = text.substring(jsonStart);\r\n        \r\n        // Try to find the end of the JSON object by counting braces\r\n        let braceCount = 0;\r\n        let jsonEnd = -1;\r\n        \r\n        for (let i = 0; i < jsonText.length; i++) {\r\n          if (jsonText[i] === '{') braceCount++;\r\n          if (jsonText[i] === '}') braceCount--;\r\n          if (braceCount === 0) {\r\n            jsonEnd = i + 1;\r\n            break;\r\n          }\r\n        }\r\n        \r\n        if (jsonEnd !== -1) {\r\n          const jsonString = jsonText.substring(0, jsonEnd);\r\n          console.log('üîç Extracted JSON string:', jsonString);\r\n          const analysisData = JSON.parse(jsonString);\r\n          rankingAnalysis = analysisData.ranking_analysis || [];\r\n          console.log('üîç Parsed ranking analysis:', rankingAnalysis);\r\n          \r\n          // Also try to extract improvement recommendations\r\n          // Try multiple patterns for improvement recommendations\r\n          let improvementStart = text.indexOf('{\\n  \"improvement_recommendations\":');\r\n          if (improvementStart === -1) {\r\n            improvementStart = text.indexOf('{ \"improvement_recommendations\":');\r\n          }\r\n          if (improvementStart === -1) {\r\n            improvementStart = text.indexOf('\"improvement_recommendations\":');\r\n          }\r\n          if (improvementStart !== -1) {\r\n            const improvementText = text.substring(improvementStart);\r\n            let improvementBraceCount = 0;\r\n            let improvementEnd = -1;\r\n            \r\n            for (let i = 0; i < improvementText.length; i++) {\r\n              if (improvementText[i] === '{') improvementBraceCount++;\r\n              if (improvementText[i] === '}') improvementBraceCount--;\r\n              if (improvementBraceCount === 0) {\r\n                improvementEnd = i + 1;\r\n                break;\r\n              }\r\n            }\r\n            \r\n            if (improvementEnd !== -1) {\r\n              try {\r\n                const improvementJsonString = improvementText.substring(0, improvementEnd);\r\n                console.log('üîç OpenAI extracted improvement JSON:', improvementJsonString);\r\n                const improvementData = JSON.parse(improvementJsonString);\r\n                improvementRecommendations = improvementData.improvement_recommendations || [];\r\n                console.log('üîç OpenAI parsed improvement recommendations:', improvementRecommendations);\r\n              } catch (e) {\r\n                console.log('üîç OpenAI failed to parse improvement recommendations:', e);\r\n              }\r\n            }\r\n          }\r\n        } else {\r\n          // Try to extract partial JSON if it's truncated\r\n          console.log('üîç JSON appears truncated, trying to extract partial data');\r\n          try {\r\n            // Look for individual ranking analysis objects\r\n            const analysisMatches = jsonText.matchAll(/\\{\\s*\"provider\"[^}]*\"llm_reasoning\"[^}]*\\}/g);\r\n            for (const match of analysisMatches) {\r\n              try {\r\n                const partialAnalysis = JSON.parse(match[0]);\r\n                if (partialAnalysis.provider && partialAnalysis.llm_reasoning) {\r\n                  rankingAnalysis.push(partialAnalysis);\r\n                }\r\n              } catch (e) {\r\n                console.log('üîç Failed to parse partial analysis:', match[0]);\r\n              }\r\n            }\r\n            console.log('üîç Extracted partial ranking analysis:', rankingAnalysis);\r\n          } catch (error) {\r\n            console.log('üîç Failed to extract partial JSON:', error);\r\n          }\r\n        }\r\n      } else {\r\n        console.log('üîç No ranking_analysis JSON found in response');\r\n        console.log('üîç Response text preview:', text.substring(0, 500));\r\n      }\r\n    } catch (error) {\r\n      console.error('Failed to parse ranking analysis:', error);\r\n      console.error('Error details:', error);\r\n    }\r\n\r\n    const payload: OpenAIResultsResponse = { \r\n      text,\r\n      rankingAnalysis,\r\n      keywordPosition: keywordPosition > 0 ? keywordPosition : undefined,\r\n      monitoringKeyword: monitoring_keyword,\r\n      improvementRecommendations: improvementRecommendations.length > 0 ? improvementRecommendations : undefined\r\n    };\r\n    res.json(payload);\r\n  } catch (error) {\r\n    res.status(500).json({ error: (error as Error).message });\r\n  }\r\n};\r\n\r\n\r\n","import type { RequestHandler } from \"express\";\r\nimport type { PerplexityResultsRequest, PerplexityResultsResponse, RankingAnalysisResponse } from \"@shared/api\";\r\n\r\nconst OPENROUTER_URL = \"https://openrouter.ai/api/v1/chat/completions\";\r\n\r\nexport const handlePerplexityResults: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { user_query, monitoring_keyword }: PerplexityResultsRequest = req.body ?? {};\r\n    console.log('üîç Perplexity request (UPDATED CODE):', { user_query, monitoring_keyword });\r\n\r\n    if (!process.env.OPENROUTER_API_KEY) {\r\n      res.status(500).json({ error: \"Missing OPENROUTER_API_KEY\" });\r\n      return;\r\n    }\r\n\r\n    if (!user_query || typeof user_query !== \"string\") {\r\n      res.status(400).json({ error: \"user_query is required\" });\r\n      return;\r\n    }\r\n\r\n    const prompt = `You are a strict formatter. Follow the output spec exactly.\r\n\r\nCONTEXT\r\n- Platform: Perplexity\r\n- user_query: \"${user_query}\"\r\n\r\nTASK\r\n1) Based on the query, return the 5 most relevant results.  \r\n   - Output strictly as a numbered list from 1 to 5.  \r\n   - Each item must be a COMPLETE result in the following exact 5-line format:\r\n     Title: <brand/model/main item>\r\n     Description: <up to 100 words>\r\n     Rating: <X/5>\r\n     Price: <$X or $A - $B>\r\n     Website: <domain or URL, if known>\r\n\r\n2) After the list, provide a simple summary of the results.\r\n\r\n3) After the summary, provide a ranking analysis for each item in this exact JSON format:\r\n{\r\n  \"ranking_analysis\": [\r\n    {\r\n      \"provider\": \"perplexity\",\r\n      \"target\": \"<item title>\",\r\n      \"rank\": <position number>,\r\n      \"matched_keywords\": [\"<keywords from query that matched>\"],\r\n      \"contextual_signals\": [\"<contextual mentions like comparisons, expert mentions>\"],\r\n      \"competitor_presence\": [\"<competitors and their ranks>\"],\r\n      \"sentiment\": \"<positive|neutral|negative>\",\r\n      \"citation_domains\": [\"<domains mentioned>\"],\r\n      \"llm_reasoning\": \"<brief explanation of why ranked this position>\"\r\n    }\r\n  ]\r\n}\r\n\r\n4) MANDATORY: If \"${monitoring_keyword || \"the query topic\"}\" appears anywhere in the results (position 2-5), you MUST provide improvement recommendations in this exact JSON format:\r\n{\r\n  \"improvement_recommendations\": [\r\n    {\r\n      \"category\": \"SEO & Content Strategy\",\r\n      \"title\": \"Optimize ${monitoring_keyword || \"the target\"} content strategy\",\r\n      \"description\": \"Create targeted content highlighting ${monitoring_keyword || \"the target\"}'s unique features and benefits\",\r\n      \"timeframe\": \"immediate\",\r\n      \"expectedImpact\": \"Could improve ranking by 1-2 positions\"\r\n    },\r\n    {\r\n      \"category\": \"Brand Strategy\", \r\n      \"title\": \"Enhance ${monitoring_keyword || \"the target\"} brand visibility\",\r\n      \"description\": \"Increase ${monitoring_keyword || \"the target\"} mentions and reviews across key platforms\",\r\n      \"timeframe\": \"mid-term\",\r\n      \"expectedImpact\": \"Better brand recognition and higher rankings\"\r\n    }\r\n  ]\r\n}\r\n\r\nCRITICAL: Always include improvement recommendations if ${monitoring_keyword || \"the target\"} is found at positions 2-5.\r\n\r\nRULES\r\n- No preface, no explanations, no extra lines.  \r\n- Keep descriptions short and factual.  \r\n- Follow format strictly.\r\n- Include ranking analysis for ALL 5 items.`;\r\n\r\n    const response = await fetch(OPENROUTER_URL, {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Authorization\": `Bearer ${process.env.OPENROUTER_API_KEY}`,\r\n        \"HTTP-Referer\": process.env.SITE_URL || \"https://geosight.app\",\r\n        \"X-Title\": process.env.SITE_NAME || \"GeoSight\",\r\n        \"Content-Type\": \"application/json\",\r\n      },\r\n      body: JSON.stringify({\r\n        model: \"openai/gpt-3.5-turbo\",\r\n        messages: [\r\n          {\r\n            role: \"user\",\r\n            content: prompt,\r\n          },\r\n        ],\r\n        max_tokens: 2048,\r\n      }),\r\n    });\r\n\r\n    if (!response.ok) {\r\n      const errText = await response.text();\r\n      res.status(response.status).json({ error: errText });\r\n      return;\r\n    }\r\n\r\n    const json = (await response.json()) as {\r\n      choices?: Array<{ message?: { content?: string } }>;\r\n    };\r\n    const text = json?.choices?.[0]?.message?.content ?? \"\";\r\n\r\n    // Check if monitoring keyword appears in the results\r\n    let keywordPosition = -1;\r\n    if (monitoring_keyword) {\r\n      const lines = text.split('\\n');\r\n      for (let i = 0; i < lines.length; i++) {\r\n        const line = lines[i];\r\n        if (line.includes('Title:') && line.toLowerCase().includes(monitoring_keyword.toLowerCase())) {\r\n          // Extract position number from the preceding numbered list item\r\n          for (let j = i - 1; j >= 0; j--) {\r\n            const match = lines[j].match(/^(\\d+)\\)/);\r\n            if (match) {\r\n              keywordPosition = parseInt(match[1]);\r\n              break;\r\n            }\r\n          }\r\n          break;\r\n        }\r\n      }\r\n    }\r\n\r\n    // Try to extract ranking analysis and improvement recommendations from the response\r\n    let rankingAnalysis: RankingAnalysisResponse[] = [];\r\n    let improvementRecommendations = [];\r\n    try {\r\n      // Look for JSON block with ranking_analysis\r\n      const jsonPattern = /\\{\\s*\"ranking_analysis\"\\s*:/;\r\n      const jsonMatch = text.match(jsonPattern);\r\n      \r\n      if (jsonMatch) {\r\n        const jsonStart = jsonMatch.index!;\r\n        const jsonText = text.substring(jsonStart);\r\n        \r\n        // Try to find the end of the JSON object by counting braces\r\n        let braceCount = 0;\r\n        let jsonEnd = -1;\r\n        \r\n        for (let i = 0; i < jsonText.length; i++) {\r\n          if (jsonText[i] === '{') braceCount++;\r\n          if (jsonText[i] === '}') braceCount--;\r\n          if (braceCount === 0) {\r\n            jsonEnd = i + 1;\r\n            break;\r\n          }\r\n        }\r\n        \r\n        if (jsonEnd !== -1) {\r\n          const jsonString = jsonText.substring(0, jsonEnd);\r\n          const analysisData = JSON.parse(jsonString);\r\n          rankingAnalysis = analysisData.ranking_analysis || [];\r\n          \r\n          // Also try to extract improvement recommendations\r\n          let improvementStart = text.indexOf('{\\n  \"improvement_recommendations\":');\r\n          if (improvementStart === -1) {\r\n            improvementStart = text.indexOf('{ \"improvement_recommendations\":');\r\n          }\r\n          if (improvementStart === -1) {\r\n            improvementStart = text.indexOf('\"improvement_recommendations\":');\r\n          }\r\n          console.log('üîç Perplexity improvement recommendations search:', {\r\n            improvementStart,\r\n            textContainsImprovement: text.includes('improvement_recommendations'),\r\n            textPreview: text.substring(0, 1000)\r\n          });\r\n          if (improvementStart !== -1) {\r\n            const improvementText = text.substring(improvementStart);\r\n            let improvementBraceCount = 0;\r\n            let improvementEnd = -1;\r\n            \r\n            for (let i = 0; i < improvementText.length; i++) {\r\n              if (improvementText[i] === '{') improvementBraceCount++;\r\n              if (improvementText[i] === '}') improvementBraceCount--;\r\n              if (improvementBraceCount === 0) {\r\n                improvementEnd = i + 1;\r\n                break;\r\n              }\r\n            }\r\n            \r\n            if (improvementEnd !== -1) {\r\n              try {\r\n                const improvementJsonString = improvementText.substring(0, improvementEnd);\r\n                console.log('üîç Perplexity extracted improvement JSON:', improvementJsonString);\r\n                const improvementData = JSON.parse(improvementJsonString);\r\n                improvementRecommendations = improvementData.improvement_recommendations || [];\r\n                console.log('üîç Perplexity parsed improvement recommendations:', improvementRecommendations);\r\n              } catch (e) {\r\n                console.log('üîç Perplexity failed to parse improvement recommendations:', e);\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('Failed to parse ranking analysis:', error);\r\n    }\r\n\r\n    const payload: PerplexityResultsResponse = { \r\n      text,\r\n      rankingAnalysis,\r\n      keywordPosition: keywordPosition > 0 ? keywordPosition : undefined,\r\n      monitoringKeyword: monitoring_keyword,\r\n      improvementRecommendations: improvementRecommendations.length > 0 ? improvementRecommendations : undefined\r\n    };\r\n    \r\n    console.log('üîç Perplexity final payload:', {\r\n      hasText: !!text,\r\n      rankingAnalysisCount: rankingAnalysis.length,\r\n      keywordPosition,\r\n      monitoringKeyword,\r\n      improvementRecommendationsCount: improvementRecommendations.length,\r\n      improvementRecommendations: improvementRecommendations\r\n    });\r\n    \r\n    res.json(payload);\r\n  } catch (error) {\r\n    console.error(\"OpenRouter API error:\", error);\r\n    res.status(500).json({ error: (error as Error).message });\r\n  }\r\n};","import \"dotenv/config\";\nimport express from \"express\";\nimport cors from \"cors\";\nimport { handleClaudeResults } from \"./routes/claude-results\";\nimport { handleGeminiResults } from \"./routes/gemini-results\";\nimport { handleOpenAIResults } from \"./routes/openai-results\";\nimport { handlePerplexityResults } from \"./routes/perplexity-results\";\n\nexport function createServer() {\n  const app = express();\n\n  // Middleware\n  app.use(cors());\n    app.use(express.json({ limit: '10mb' }));\n  app.use(express.urlencoded({ extended: true, limit: '10mb' }));\n  \n  // Debug middleware\n  app.use((req, res, next) => {\n    console.log('üîç Request:', { method: req.method, url: req.url, body: req.body });\n    next();\n  });\n\n  // Example API routes\n  app.get(\"/api/ping\", (_req, res) => {\n    const ping = process.env.PING_MESSAGE ?? \"ping\";\n    res.json({ message: ping });\n  });\n\n  // Test endpoint to verify function is working\n  app.post(\"/api/test\", (req, res) => {\n    console.log('üîç Test endpoint hit:', { body: req.body, headers: req.headers });\n    res.json({ \n      message: \"Test endpoint working\", \n      body: req.body,\n      hasBody: !!req.body,\n      bodyKeys: req.body ? Object.keys(req.body) : []\n    });\n  });\n\n\n  // Claude results endpoint\n  app.post(\"/api/claude/results\", handleClaudeResults);\n  // Gemini results endpoint\n  app.post(\"/api/gemini/results\", handleGeminiResults);\n  // OpenAI results endpoint\n  app.post(\"/api/openai/results\", handleOpenAIResults);\n  // Perplexity results endpoint\n  app.post(\"/api/perplexity/results\", handlePerplexityResults);\n\n  return app;\n}\n","import path from \"path\";\nimport { createServer } from \"./index\";\nimport * as express from \"express\";\n\nconst app = createServer();\nconst port = process.env.PORT || 3000;\n\n// In production, serve the built SPA files\nconst __dirname = import.meta.dirname;\nconst distPath = path.join(__dirname, \"../spa\");\n\n// Serve static files\napp.use(express.static(distPath));\n\n// Handle React Router - serve index.html for all non-API routes\napp.get(\"/*\", (req, res) => {\n  // Don't serve index.html for API routes\n  if (req.path.startsWith(\"/api/\") || req.path.startsWith(\"/health\")) {\n    return res.status(404).json({ error: \"API endpoint not found\" });\n  }\n\n  res.sendFile(path.join(distPath, \"index.html\"));\n});\n\napp.listen(port, () => {\n  console.log(`üöÄ Fusion Starter server running on port ${port}`);\n  console.log(`üì± Frontend: http://localhost:${port}`);\n  console.log(`üîß API: http://localhost:${port}/api`);\n});\n\n// Graceful shutdown\nprocess.on(\"SIGTERM\", () => {\n  console.log(\"üõë Received SIGTERM, shutting down gracefully\");\n  process.exit(0);\n});\n\nprocess.on(\"SIGINT\", () => {\n  console.log(\"üõë Received SIGINT, shutting down gracefully\");\n  process.exit(0);\n});\n"],"names":["text","app","express"],"mappings":"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"}